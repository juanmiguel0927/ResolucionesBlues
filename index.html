<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resoluciones Blues</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Incluir la biblioteca Tone.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0C1821;
            color: #E0E0E0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 0.25rem;
            box-sizing: border-box;
            overflow-y: auto;
        }
        
        .container {
            background-color: #0C1821;
            padding: 0.5rem;
            border-radius: 1rem;
            box-shadow: none; 
            width: 100%;
            max-width: 600px;
            border: none;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        h1 {
            margin-bottom: 0.15rem;
            font-size: 2rem;
        }

        .subtitle {
            margin-bottom: 0.4rem;
            font-size: 0.85rem;
        }
        
        /* Controles de la UI */
        .controls-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 300px;
        }

        .controls-row {
            display: flex;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            margin-bottom: 0.2rem;
            width: 100%;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 0.3rem;
            width: 100%;
        }

        .select-label {
            margin-bottom: 0.05rem;
            font-weight: bold;
            font-size: 0.8rem;
        }

        .select-input {
            width: 100%;
            padding: 0.3rem;
            border-radius: 0.5rem;
            background-color: #333;
            color: #E0E0E0;
            border: 1px solid #444;
            text-align: center;
            font-size: 0.8rem;
        }

        .bpm-input {
            width: 100%;
        }
        
        /* Botones de resoluciones */
        .resolution-button {
            width: 100%;
            padding: 0.5rem;
            font-size: 1rem;
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.1s ease-in-out, background-color 0.1s ease-in-out;
            user-select: none;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            background-color: #1E8449;
            color: white;
            text-align: center;
            border: none;
        }
        .resolution-button:hover {
            background-color: #27AE60;
        }
        .resolution-button:active {
            transform: scale(0.95);
        }
        
        /* Estilo para los botones seleccionados */
        .resolution-button.selected {
            background-color: #F1C40F;
            color: #0C1821;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .resolution-description {
            font-size: 0.75rem;
            color: #BDBDBD;
            margin-top: 0.15rem;
            font-weight: normal;
        }
        
        .highlighted-note {
            color: #F1C40F;
            font-weight: bold;
            transition: color 0.1s ease-in-out;
        }
        .resolution-button.selected .resolution-description {
            color: #333;
        }
        
        /* Estilos de cuadrícula para los botones */
        .resolutions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.4rem;
            margin-top: 0.4rem;
        }
        
        /* Estilos para el panel de selecciones y los botones de control */
        .selection-panel {
            background-color: #2C3E50;
            border-radius: 0.5rem;
            padding: 0.5rem;
            margin-top: 0.8rem;
            width: 100%;
        }

        .selection-panel-title {
            font-size: 1rem;
            font-weight: bold;
            margin-bottom: 0.4rem;
        }

        .selection-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.2rem;
            min-height: 2rem;
        }

        .selected-item {
            background-color: #5D5D5D;
            color: #E0E0E0;
            padding: 0.2rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
        }

        .action-buttons {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            justify-content: center;
            width: 100%;
        }

        .action-button {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            font-weight: bold;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: transform 0.1s ease-in-out, background-color 0.1s ease-in-out;
        }

        .play-button {
            background-color: #3498DB;
            color: white;
        }
        .play-button:hover {
            background-color: #2980B9;
        }

        .clear-button {
            background-color: #E74C3C;
            color: white;
        }
        .clear-button:hover {
            background-color: #C0392B;
        }

        /* Estilo para los créditos */
        .credits {
            margin-top: 0.5rem;
            font-size: 0.7rem;
            color: #BDBDBD;
        }

        /* Media query para adaptar la cuadrícula a pantallas más grandes */
        @media (min-width: 640px) {
            .resolutions-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }
    </style>
</head>
<body>

    <div class="container mx-auto rounded-xl">
        <h1 class="text-3xl font-bold text-center">Resoluciones Blues</h1>
        <p class="text-center text-gray-400 subtitle">
            Selecciona el tipo de acorde, la fundamental y el ritmo para escuchar las resoluciones.
        </p>
        
        <div class="controls-container">
            <div class="controls">
                <label for="chordType" class="select-label">Tipo de Acorde:</label>
                <select id="chordType" class="select-input">
                    <option value="major">Mayor / Dominante</option>
                    <option value="minor">Menor</option>
                </select>
            </div>
    
            <div class="controls">
                <label for="rootNote" class="select-label">Fundamental:</label>
                <select id="rootNote" class="select-input">
                    <option value="C">C</option>
                    <option value="C#">C# / Db</option>
                    <option value="D">D</option>
                    <option value="D#">D# / Eb</option>
                    <option value="E">E</option>
                    <option value="F">F</option>
                    <option value="F#">F# / Gb</option>
                    <option value="G">G</option>
                    <option value="G#">G# / Ab</option>
                    <option value="A">A</option>
                    <option value="A#">A# / Bb</option>
                    <option value="B">B</option>
                </select>
            </div>
    
            <div class="controls-row">
                <div class="controls">
                    <label for="bpm" class="select-label">BPM:</label>
                    <input type="number" id="bpm" class="select-input bpm-input" value="80" min="40" max="240">
                </div>
                <div class="controls">
                    <label for="rhythm" class="select-label">Ritmo:</label>
                    <select id="rhythm" class="select-input">
                        <option value="1">Negra</option>
                        <option value="0.5" selected>Corchea</option>
                        <option value="0.25">Semicorchea</option>
                    </select>
                </div>
            </div>
        </div>
        
        <div id="resolutions-panel" class="resolutions-grid">
            <!-- Los botones se generarán con JavaScript -->
        </div>

        <!-- Nuevo panel para las resoluciones seleccionadas -->
        <div class="selection-panel">
            <div class="selection-panel-title">Resoluciones Seleccionadas:</div>
            <div id="selected-resolutions-list" class="selection-list">
                <!-- Los nombres de las resoluciones seleccionadas aparecerán aquí -->
            </div>
            <div class="action-buttons">
                <button id="play-combination-button" class="action-button play-button">Reproducir</button>
                <button id="clear-selection-button" class="action-button clear-button">Limpiar</button>
            </div>
        </div>

        <p class="text-center credits">Diseñado por Juan Miguel Ríos Redondo</p>
    </div>

    <script>
        // Declarar las variables globales para el sintetizador y los efectos de Tone.js
        let synth;
        let reverb;
        let isPlaying = false;
        
        // Array para almacenar las resoluciones seleccionadas
        let selectedResolutions = [];

        // Frecuencias base para cada nota
        const baseFrequencies = {
            'C': 261.63, 'C#': 277.18, 'D': 293.66, 'D#': 311.13, 'E': 329.63, 'F': 349.23,
            'F#': 369.99, 'G': 392.00, 'G#': 415.30, 'A': 440.00, 'A#': 466.16, 'B': 493.88
        };

        // Mapeo de intervalos a semitonos desde la fundamental
        const intervalSemitones = {
            '1': 0, '2': 2, '#2': 3, 'b3': 3, '3': 4, '4': 5, '#4': 6, 'b5': 6, '5': 7, '6': 9, 'b7': 10
        };

        // Nombres de notas para sostenidos y bemoles
        const sharpNotes = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
        const flatNotes = ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'];

        // Resoluciones para acordes mayores y dominantes
        const resolutionsMajor = [
            { id: 'major-0', name: 'Resolución de #2', formula: ['#2', '3', '1'] },
            { id: 'major-1', name: 'Resolución de b3', formula: ['b3', '2', '1'] },
            { id: 'major-2', name: 'Resolución de 4', formula: ['4', '#2', '3', '1'] },
            { id: 'major-3', name: 'Resolución de #4', formula: ['3', '4', '#4', '5', '#2', '3', '1'] },
            { id: 'major-4', name: 'Resolución de b5', formula: ['b5', '4', '#2', '4', '#2', '3', '1'] },
            { id: 'major-5', name: 'Resolución de b7 versión 1', formula: ['b7', '5'] },
            { id: 'major-6', name: 'Resolución de b7 versión 2', formula: ['b7', '6', '5'] },
        ];
        
        // Resoluciones para acordes menores
        const resolutionsMinor = [
            { id: 'minor-0', name: 'Resolución de 2', formula: ['2', 'b3', '1'] },
            { id: 'minor-1', name: 'Resolución de b5', formula: ['b5', '5', 'b3'] },
            { id: 'minor-2', name: 'Resolución de b7', formula: ['b7', '6', '5', 'b3'] },
            { id: 'minor-3', name: 'Resolución de 6', formula: ['6', 'b7', 'b3'] },
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar Tone.js en la primera interacción del usuario
            document.body.addEventListener('click', initTone, { once: true });
            document.body.addEventListener('touchstart', initTone, { once: true });
            
            const chordTypeSelector = document.getElementById('chordType');
            const rootNoteSelector = document.getElementById('rootNote');
            const bpmInput = document.getElementById('bpm');
            const rhythmSelector = document.getElementById('rhythm');
            const resolutionsPanel = document.getElementById('resolutions-panel');
            const playButton = document.getElementById('play-combination-button');
            const clearButton = document.getElementById('clear-selection-button');
            const selectedResolutionsList = document.getElementById('selected-resolutions-list');
            
            chordTypeSelector.addEventListener('change', updateUI);
            rootNoteSelector.addEventListener('change', updateUI);
            bpmInput.addEventListener('change', updateUI);
            rhythmSelector.addEventListener('change', updateUI);
            playButton.addEventListener('click', playCombinedSequence);
            clearButton.addEventListener('click', clearSelection);
            
            updateUI(); // Generar la UI inicial

            function initTone() {
                // Crear el sintetizador y los efectos
                synth = new Tone.PolySynth(Tone.FMSynth, {
                    oscillator: { type: "triangle" },
                    envelope: {
                        attack: 0.05,
                        decay: 0.1,
                        sustain: 0.3,
                        release: 0.8
                    }
                }).toDestination();
                
                reverb = new Tone.Reverb({
                    decay: 4,
                    preDelay: 0.01,
                    wet: 0.3 // Cantidad de efecto
                }).toDestination();

                // Conectar el sintetizador al reverb y el reverb a la salida
                synth.connect(reverb);
                reverb.toDestination();
                
                // Asegurar que el contexto de audio está activo
                Tone.start();
            }

            function updateUI() {
                const rootNote = rootNoteSelector.value;
                const chordType = chordTypeSelector.value;
                
                const selectedResolutionsData = chordType === 'major' ? resolutionsMajor : resolutionsMinor;
                
                resolutionsPanel.innerHTML = ''; // Limpiar los botones existentes

                selectedResolutionsData.forEach((resolution, resIndex) => {
                    const button = document.createElement('button');
                    button.className = 'resolution-button';
                    button.setAttribute('data-id', resolution.id);
                    button.setAttribute('data-res-index', resIndex); // Añadir índice para el resaltado

                    const noteNames = resolution.formula.map((interval, i) =>
                        `<span class="note-name-${resolution.id}-${i}">${getNoteName(rootNote, interval)}</span>`
                    ).join(' → ');

                    const formulaParts = resolution.formula.map((interval, i) =>
                        `<span class="formula-part-${resolution.id}-${i}">${interval}</span>`
                    ).join(' → ');
                    
                    button.innerHTML = `
                        <span>${resolution.name}</span>
                        <span class="resolution-description">Notas: ${noteNames}</span>
                        <span class="resolution-description">Fórmula: ${formulaParts}</span>
                    `;
                    
                    button.addEventListener('click', async () => {
                        const index = selectedResolutions.indexOf(resolution.id);

                        if (index === -1) {
                            // La resolución NO está seleccionada, la seleccionamos y reproducimos
                            selectedResolutions.push(resolution.id);
                            button.classList.add('selected');
                            updateSelectedListUI();

                            if (!isPlaying) {
                                const notes = resolution.formula.map(interval => getNoteName(rootNote, interval) + '4');
                                const bpm = parseInt(bpmInput.value, 10);
                                const rhythmFactor = parseFloat(rhythmSelector.value);
                                const noteDuration = (60000 / bpm) * rhythmFactor;
                                await playSequence(resolution.id, notes, noteDuration);
                            }
                        } else {
                            // La resolución YA está seleccionada, la deseleccionamos
                            selectedResolutions.splice(index, 1);
                            button.classList.remove('selected');
                            updateSelectedListUI();
                            // NO se reproduce el sonido al deseleccionar
                        }
                    });

                    resolutionsPanel.appendChild(button);
                });

                // Mantener el estado de selección al actualizar la UI
                selectedResolutions.forEach(id => {
                    const button = document.querySelector(`.resolution-button[data-id="${id}"]`);
                    if (button) {
                        button.classList.add('selected');
                    }
                });
                updateSelectedListUI();
            }

            function updateSelectedListUI() {
                selectedResolutionsList.innerHTML = '';
                if (selectedResolutions.length === 0) {
                    selectedResolutionsList.innerHTML = '<span class="selected-item">Ninguna</span>';
                } else {
                    selectedResolutions.forEach(id => {
                        const chordType = chordTypeSelector.value;
                        const resolutionsData = chordType === 'major' ? resolutionsMajor : resolutionsMinor;
                        const resolution = resolutionsData.find(res => res.id === id);
                        if (resolution) {
                            const item = document.createElement('span');
                            item.className = 'selected-item';
                            item.textContent = resolution.name;
                            selectedResolutionsList.appendChild(item);
                        }
                    });
                }
            }
            
            async function playCombinedSequence() {
                if (!synth || isPlaying) {
                    return;
                }

                if (selectedResolutions.length === 0) {
                    console.log('No hay resoluciones seleccionadas.');
                    return;
                }

                isPlaying = true;
                const bpm = parseInt(bpmInput.value, 10);
                const rhythmFactor = parseFloat(rhythmSelector.value);
                const noteDuration = (60000 / bpm) * rhythmFactor;
                const rootNote = rootNoteSelector.value;
                const chordType = chordTypeSelector.value;
                const resolutionsData = chordType === 'major' ? resolutionsMajor : resolutionsMinor;

                for (const id of selectedResolutions) {
                    const resolution = resolutionsData.find(res => res.id === id);
                    if (resolution) {
                        const notes = resolution.formula.map(interval => getNoteName(rootNote, interval) + '4');
                        // Reproducir cada resolución en la secuencia combinada
                        await playSequence(id, notes, noteDuration);
                    }
                }
                
                isPlaying = false;
            }

            function clearSelection() {
                selectedResolutions = [];
                const buttons = document.querySelectorAll('.resolution-button.selected');
                buttons.forEach(button => button.classList.remove('selected'));
                updateSelectedListUI();
            }

            // Función para obtener el nombre de la nota con sostenidos o bemoles
            function getNoteName(root, interval) {
                const rootIndex = sharpNotes.indexOf(root);
                const semitones = intervalSemitones[interval];
                const noteIndex = (rootIndex + semitones + 12) % 12;

                if (interval.includes('b')) {
                    return flatNotes[noteIndex];
                } else if (interval.includes('#')) {
                    return sharpNotes[noteIndex];
                } else {
                    const flatNotesForNaturals = {
                        'F': 'Bb',
                        'G#': 'C#',
                        'A#': 'D#',
                    };
                    if (root === 'F' && interval === '4') {
                        return 'Bb';
                    }
                    if (root === 'G#' && interval === '4') {
                        return 'C#';
                    }
                    if (root === 'A#' && interval === '4') {
                        return 'D#';
                    }
                    return sharpNotes[noteIndex];
                }
            }
            
            // Función para reproducir una secuencia de notas con Tone.js
            async function playSequence(resId, notes, noteDuration) {
                if (!synth) return;
                
                isPlaying = true;
                
                for (let i = 0; i < notes.length; i++) {
                    const note = notes[i];
                    
                    // Resaltar la nota y la fórmula actual
                    const noteElement = document.querySelector(`.note-name-${resId}-${i}`);
                    const formulaElement = document.querySelector(`.formula-part-${resId}-${i}`);
                    if (noteElement) noteElement.classList.add('highlighted-note');
                    if (formulaElement) formulaElement.classList.add('highlighted-note');
                    
                    // Disparar la nota con Tone.js
                    synth.triggerAttackRelease(note, noteDuration / 1000);
                    
                    // Esperar la duración de la nota antes de pasar a la siguiente
                    await new Promise(resolve => setTimeout(resolve, noteDuration));
                    
                    // Quitar el resaltado después de la duración de la nota
                    if (noteElement) noteElement.classList.remove('highlighted-note');
                    if (formulaElement) formulaElement.classList.remove('highlighted-note');
                }
                
                isPlaying = false;
            }
        });
    </script>
</body>
</html>

