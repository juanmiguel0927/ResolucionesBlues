<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resoluciones Blues</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        /* Importa la fuente Inter de Google Fonts para una apariencia moderna */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        /* Estilos base para el cuerpo de la página */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0C1821;
            color: #E0E0E0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 1rem;
            box-sizing: border-box;
            min-height: 100vh;
        }

        /* Contenedor principal para toda la aplicación */
        .container {
            background-color: #121E2A;
            padding: 1.5rem;
            border-radius: 1.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 600px;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        /* Estilo para el título principal */
        h1 {
            font-size: 3rem !important; 
            font-weight: 700;
            text-align: center;
            line-height: 1.2;
            margin-bottom: 0.25rem;
            color: #FFFFFF;
        }

        /* Estilo para el subtítulo y los créditos */
        .subtitle {
            font-size: 0.875rem; 
            color: #A0A0A0;
            text-align: center;
            margin-top: 0;
        }
        
        .credits {
            font-size: 0.75rem; 
            color: #707070;
            text-align: center;
            margin-top: 0.25rem;
        }

        /* Estilo general para los paneles de control y selección */
        .panel {
            background-color: #1A2430;
            border-radius: 1rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        /* Ajuste para el grid, permitiendo que los elementos se adapten */
        .panel-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(130px, 1fr));
            gap: 1rem;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            width: 100%;
        }
        
        .input-label {
            font-weight: 600;
            font-size: 0.875rem; 
            margin-bottom: 0.25rem;
            text-align: center;
        }

        .select-input, .text-input {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: #2C3E50;
            color: #E0E0E0;
            border: 1px solid #444;
            font-size: 0.875rem; 
        }

        /* Estilo para los botones de acción principales */
        .action-button {
            padding: 0.75rem 1.5rem;
            font-size: 1rem; 
            font-weight: 700;
            border-radius: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            border: none;
        }
        
        .action-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.4);
        }
        
        .action-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .generate-button {
            background-color: #F39C12;
            color: white;
            flex-grow: 1;
        }

        .play-button {
            background-color: #3498DB;
            color: white;
            flex-grow: 1;
        }
        
        .stop-button {
            background-color: #E74C3C;
            color: white;
            flex-grow: 1;
        }

        .clear-button {
            background-color: #E74C3C;
            color: white;
            flex-grow: 1;
        }

        /* Estilo para los botones de resolución */
        .resolution-button {
            width: 100%;
            padding: 0.75rem;
            font-size: 0.875rem; 
            font-weight: 600;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #1E8449;
            color: white;
            border: none;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
            text-align: center;
        }
        
        .resolution-button:hover {
            background-color: #27AE60;
        }
        .resolution-button:active {
            transform: scale(0.98);
        }
        
        .resolution-button.selected {
            background-color: #F1C40F;
            color: #0C1821;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.4);
        }
        
        /* CORRECCIÓN: Resalta la nota y la fórmula con color negro y negrita */
        .resolution-button.selected .note-to-highlight,
        .resolution-button.selected .formula-part {
            color: black; 
            font-weight: bold;
        }
        
        /* ESTILO CORREGIDO: Resalta la nota individualmente cuando se está reproduciendo */
        .note-to-highlight.playing-note,
        .formula-part.playing-note {
            color: #3498DB; 
            transform: scale(1.1);
            transition: all 0.2s ease-in-out;
        }


        .resolution-description {
            font-size: 0.75rem; 
            color: #BDBDBD;
            margin-top: 0.25rem;
            font-weight: normal;
        }

        /* Asegura que el texto de la nota sea visible y negrita */
        .note-to-highlight {
            color: #E0E0E0;
            font-weight: bold;
        }
        
        /* Aplica el mismo estilo de las notas a los números de la fórmula */
        .formula-part {
            color: #E0E0E0;
            font-weight: bold;
        }

        /* Estilo para el panel de la combinación final */
        .final-combination-panel {
            background-color: #2C3E50;
            border-radius: 1rem;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            min-height: 4rem;
        }

        .section-title {
            font-size: 0.875rem; 
            font-weight: 600;
            color: #A0A0A0;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .notes-display-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            justify-content: center;
            align-items: center;
        }

        .note-item {
            background-color: #5D5D5D;
            color: #E0E0E0;
            padding: 0.5rem 0.75rem;
            border-radius: 0.5rem;
            font-size: 0.875rem; 
            font-weight: 600;
            white-space: nowrap;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        
        .note-item:hover {
            transform: translateY(-2px);
        }

        /* ESTILO CORREGIDO: Resalta la nota cuando se reproduce */
        .note-item.playing {
            background-color: #3498DB;
            color: white;
            transform: scale(1.05);
        }
        
        /* Oculta un elemento */
        .hidden {
            display: none;
        }
        
        /* Estilos para el slider de BPM */
        input[type=range] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            background: #2C3E50;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
        
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498DB;
            cursor: pointer;
        }
        
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #3498DB;
            cursor: pointer;
        }

        /* Grid para las resoluciones */
        .resolutions-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem;
        }

        /* Contraste para los botones de modo de escala personalizada */
        .mode-button {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            border-radius: 0.5rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            background-color: #444444; 
            color: #E0E0E0; 
            border: none;
        }

        .mode-button.selected {
            background-color: #3498DB; 
            color: white; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>
    <div class="container mx-auto">
        <h1>Resoluciones Blues</h1>
        <p class="subtitle">
            Crea melodías combinando notas aleatorias y resoluciones.
        </p>
        <p class="credits">Diseñado por Juan Miguel Ríos Redondo</p>
        
        <!-- Panel de Controles Principales -->
        <div class="panel">
            <div class="panel-grid">
                <div class="input-group">
                    <label for="scaleSelect" class="input-label">Escala:</label>
                    <select id="scaleSelect" class="select-input">
                        <option value="Major">Mayor</option>
                        <option value="Minor">Menor</option>
                        <option value="Custom">Personalizada</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="rootNote" class="input-label">Fundamental:</label>
                    <select id="rootNote" class="select-input"></select>
                </div>
                <div class="input-group">
                    <label for="bpm" class="input-label">BPM: <span id="bpmValue">160</span></label>
                    <input type="range" id="bpm" class="text-input" value="160" min="40" max="240">
                </div>
                <div class="input-group">
                    <label for="rhythm" class="input-label">Ritmo:</label>
                    <select id="rhythm" class="select-input">
                        <option value="1">Negra</option>
                        <option value="0.5" selected>Corchea</option>
                        <option value="0.25">Semicorchea</option>
                    </select>
                </div>
                <div class="input-group">
                    <label class="input-label">Enarmónicos:</label>
                    <button id="enharmonicToggleButton" class="action-button bg-blue-500 w-full mt-1">Mostrar Bemoles (b)</button>
                </div>
                <div class="input-group">
                    <label for="numNotesSelect" class="input-label">Notas Aleatorias (1-7):</label>
                    <select id="numNotesSelect" class="select-input">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5" selected>5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                    </select>
                </div>
            </div>
            
            <!-- Botones de acción agrupados y centrados -->
            <div class="flex justify-center gap-2 w-full mt-4">
                <button id="generate-sequence-button" class="action-button generate-button">Generar Secuencia</button>
                <button id="play-combination-button" class="action-button play-button">Reproducir</button>
                <button id="stop-button" class="action-button stop-button hidden">Detener</button>
                <button id="clear-selection-button" class="action-button clear-button">Limpiar Todo</button>
            </div>
            
            <!-- Controles para la Escala Personalizada -->
            <div id="customScaleInputContainer" class="hidden flex-col gap-2">
                <div class="flex justify-center gap-2">
                    <!-- Botones que se resaltan al seleccionar con mayor contraste -->
                    <button id="formulaModeButton" class="mode-button">Fórmula</button>
                    <button id="notesModeButton" class="mode-button">Notas</button>
                </div>
                <div id="intervalGrid" class="notes-display-grid"></div>
                <div id="chromaticNotesGrid" class="notes-display-grid hidden"></div>
            </div>
        </div>
        
        <!-- Panel de Resoluciones Mayores -->
        <div class="panel">
            <span class="section-title">Resoluciones Mayores:</span>
            <div class="resolutions-grid" id="major-resolutions-panel"></div>
        </div>

        <!-- Panel de Resoluciones Menores -->
        <div class="panel">
            <span class="section-title">Resoluciones Menores:</span>
            <div class="resolutions-grid" id="minor-resolutions-panel"></div>
        </div>

        <!-- Panel de Combinación Final -->
        <div class="final-combination-panel">
            <span class="section-title">Combinación Final:</span>
            <div id="final-combination-list" class="notes-display-grid">
                <span class="note-item">Vacío</span>
            </div>
        </div>
    </div>

    <script>
        // Objeto principal que maneja el estado de la aplicación y la lógica
        const App = {
            // Estado de la aplicación
            state: {
                synth: null,
                isPlaying: false,
                randomSequence: [],
                selectedResolutions: [],
                customScaleMode: 'formula',
                isFlatMode: false
            },

            // Datos de las escalas y resoluciones
            data: {
                intervalSemitones: {
                    '1': 0, 'b2': 1, '2': 2, 'b3': 3, '3': 4, '4': 5, 'b5': 6, '5': 7, '#5': 8, 'b6': 8, '6': 9, 'b7': 10, '7': 11, '#2': 3, '#4': 6, '#9': 4, '#13': 9
                },
                chromaticNotesCanonical: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
                scalesData: {
                    'Major': ['1', '2', '3', '4', '5', '6', '7'],
                    'Minor': ['1', '2', 'b3', '4', '5', 'b6', 'b7']
                },
                resolutionsMajor: [
                    { id: 'major-0', name: 'Resolución de #2', formula: ['#2', '3', '1'] },
                    { id: 'major-1', name: 'Resolución de b3', formula: ['b3', '2', '1'] },
                    { id: 'major-2', name: 'Resolución de 4', formula: ['4', '#2', '3', '1'] },
                    { id: 'major-3', name: 'Resolución de #4', formula: ['3', '4', '#4', '5', '#2', '3', '1'] },
                    { id: 'major-4', name: 'Resolución de b5', formula: ['b5', '4', '#2', '3', '1'] },
                    { id: 'major-5', name: 'Resolución de b7 versión 1', formula: ['b7', '5'] },
                    { id: 'major-6', name: 'Resolución de b7 versión 2', formula: ['b7', '6', '5'] },
                ],
                resolutionsMinor: [
                    { id: 'minor-0', name: 'Resolución de 2', formula: ['2', 'b3', '1'] },
                    { id: 'minor-1', name: 'Resolución de b5', formula: ['b5', '5', 'b3'] },
                    { id: 'minor-2', name: 'Resolución de b7', formula: ['b7', '6', '5', 'b3'] },
                    { id: 'minor-3', name: 'Resolución de 6', formula: ['6', 'b7', 'b3'] },
                ],
                enharmonicNames: {
                    'C': { sharp: 'C', flat: 'C' },
                    'C#': { sharp: 'C#', flat: 'Db' },
                    'D': { sharp: 'D', flat: 'D' },
                    'D#': { sharp: 'D#', flat: 'Eb' },
                    'E': { sharp: 'E', flat: 'E' },
                    'F': { sharp: 'F', flat: 'F' },
                    'F#': { sharp: 'F#', flat: 'Gb' },
                    'G': { sharp: 'G', flat: 'G' },
                    'G#': { sharp: 'G#', flat: 'Ab' },
                    'A': { sharp: 'A', flat: 'A' },
                    'A#': { sharp: 'A#', flat: 'Bb' },
                    'B': { sharp: 'B', flat: 'B' }
                },
                allIntervals: ['1', 'b2', '2', '#2', 'b3', '3', '4', '#4', 'b5', '5', '#5', 'b6', '6', 'b7', '7']
            },

            // Elementos del DOM
            elements: {
                scaleSelect: document.getElementById('scaleSelect'),
                customScaleInputContainer: document.getElementById('customScaleInputContainer'),
                rootNoteSelector: document.getElementById('rootNote'),
                enharmonicToggleButton: document.getElementById('enharmonicToggleButton'),
                numNotesSelect: document.getElementById('numNotesSelect'),
                bpmInput: document.getElementById('bpm'),
                bpmValue: document.getElementById('bpmValue'),
                rhythmSelector: document.getElementById('rhythm'),
                generateButton: document.getElementById('generate-sequence-button'),
                majorResolutionsPanel: document.getElementById('major-resolutions-panel'),
                minorResolutionsPanel: document.getElementById('minor-resolutions-panel'),
                playButton: document.getElementById('play-combination-button'),
                stopButton: document.getElementById('stop-button'),
                clearButton: document.getElementById('clear-selection-button'),
                finalCombinationList: document.getElementById('final-combination-list'),
                formulaModeButton: document.getElementById('formulaModeButton'),
                notesModeButton: document.getElementById('notesModeButton'),
                intervalGrid: document.getElementById('intervalGrid'),
                chromaticNotesGrid: document.getElementById('chromaticNotesGrid')
            },

            // Inicializa la aplicación
            init: function() {
                this.bindEvents();
                this.updateRootNoteSelector();
                this.generateIntervalsUI();
                this.generateChromaticNotesUI();
                this.updateUI();
                this.setCustomScaleMode('formula'); // Establece el modo inicial
            },

            // Asigna los oyentes de eventos
            bindEvents: function() {
                const elements = this.elements;
                elements.scaleSelect.addEventListener('change', this.handleScaleSelectChange.bind(this));
                elements.rootNoteSelector.addEventListener('change', this.updateUI.bind(this));
                elements.enharmonicToggleButton.addEventListener('click', this.toggleEnharmonicMode.bind(this));
                elements.generateButton.addEventListener('click', this.generateSequence.bind(this));
                elements.majorResolutionsPanel.addEventListener('click', this.handleResolutionClick.bind(this));
                elements.minorResolutionsPanel.addEventListener('click', this.handleResolutionClick.bind(this));
                elements.playButton.addEventListener('click', this.playCombinedSequence.bind(this));
                elements.stopButton.addEventListener('click', this.stopPlayback.bind(this));
                elements.clearButton.addEventListener('click', this.clearAll.bind(this));
                elements.finalCombinationList.addEventListener('click', this.handleFinalCombinationClick.bind(this));
                elements.formulaModeButton.addEventListener('click', () => this.setCustomScaleMode('formula'));
                elements.notesModeButton.addEventListener('click', () => this.setCustomScaleMode('notes'));
                elements.bpmInput.addEventListener('input', (event) => {
                    elements.bpmValue.textContent = event.target.value;
                });
            },

            // Inicializa el motor de audio Tone.js
            initTone: async function() {
                try {
                    if (Tone.context.state !== 'running') {
                        await Tone.start();
                    }
                    if (!this.state.synth) {
                        this.state.synth = new Tone.PolySynth(Tone.FMSynth, {
                            oscillator: { type: "triangle" },
                            envelope: {
                                attack: 0.05,
                                decay: 0.1,
                                sustain: 0.3,
                                release: 0.8
                            }
                        }).toDestination();
                    }
                } catch (error) {
                    console.error('Error initializing Tone.js:', error);
                    this.showMessage('Ocurrió un error al inicializar el audio.');
                }
            },

            // Maneja el cambio del selector de escala
            handleScaleSelectChange: function() {
                if (this.elements.scaleSelect.value === 'Custom') {
                    this.elements.customScaleInputContainer.classList.remove('hidden');
                } else {
                    this.elements.customScaleInputContainer.classList.add('hidden');
                }
                this.updateUI();
            },

            // Establece el modo de escala personalizada (Fórmula o Notas)
            setCustomScaleMode: function(mode) {
                this.state.customScaleMode = mode;
                // Aplica y quita la clase 'selected' para el contraste visual
                this.elements.formulaModeButton.classList.toggle('selected', mode === 'formula');
                this.elements.notesModeButton.classList.toggle('selected', mode === 'notes');
                this.elements.intervalGrid.classList.toggle('hidden', mode === 'notes');
                this.elements.chromaticNotesGrid.classList.toggle('hidden', mode === 'formula');
            },

            // Genera la interfaz de usuario para los intervalos
            generateIntervalsUI: function() {
                this.elements.intervalGrid.innerHTML = '';
                this.data.allIntervals.forEach(interval => {
                    const button = document.createElement('button');
                    button.className = 'note-item cursor-pointer';
                    button.textContent = interval;
                    button.setAttribute('data-interval', interval);
                    button.addEventListener('click', () => button.classList.toggle('bg-blue-600'));
                    this.elements.intervalGrid.appendChild(button);
                });
            },

            // Genera la interfaz de usuario para las notas cromáticas
            generateChromaticNotesUI: function() {
                this.elements.chromaticNotesGrid.innerHTML = '';
                const notesToDisplay = this.state.isFlatMode ? ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'] : ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                notesToDisplay.forEach(noteToDisplay => {
                    const button = document.createElement('button');
                    button.className = 'note-item cursor-pointer';
                    button.textContent = noteToDisplay;
                    const canonicalNote = Object.keys(this.data.enharmonicNames).find(key => this.data.enharmonicNames[key].flat === noteToDisplay || this.data.enharmonicNames[key].sharp === noteToDisplay);
                    button.setAttribute('data-note', canonicalNote);
                    button.addEventListener('click', () => button.classList.toggle('bg-blue-600'));
                    this.elements.chromaticNotesGrid.appendChild(button);
                });
            },

            // Actualiza el selector de nota fundamental
            updateRootNoteSelector: function(currentRoot = 'C') {
                const rootNoteSelector = this.elements.rootNoteSelector;
                rootNoteSelector.innerHTML = '';
                
                const notesToDisplay = this.state.isFlatMode ? ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'] : ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

                notesToDisplay.forEach((note, index) => {
                    const option = document.createElement('option');
                    option.value = this.data.chromaticNotesCanonical[index];
                    option.textContent = note;
                    rootNoteSelector.appendChild(option);
                });
                rootNoteSelector.value = currentRoot;
            },

            // Alterna entre bemoles y sostenidos
            toggleEnharmonicMode: function() {
                const currentRoot = this.elements.rootNoteSelector.value;
                this.state.isFlatMode = !this.state.isFlatMode;
                this.elements.enharmonicToggleButton.textContent = this.state.isFlatMode ? 'Mostrar Sostenidos (#)' : 'Mostrar Bemoles (b)';
                this.updateRootNoteSelector(currentRoot);
                this.generateChromaticNotesUI();
                this.updateUI(); // Llama a la función de actualización de la UI para regenerar las notas
            },

            // Obtiene el nombre de la nota enarmónico
            getNoteName: function(rootCanonical, interval) {
                const rootIndex = this.data.chromaticNotesCanonical.indexOf(rootCanonical);
                const semitones = this.data.intervalSemitones[interval];
                if (semitones === undefined) return 'N/A';
                const targetIndex = (rootIndex + semitones + 12) % 12;
                const canonicalTarget = this.data.chromaticNotesCanonical[targetIndex];
                
                if (interval.includes('b')) {
                    return this.data.enharmonicNames[canonicalTarget].flat;
                } else if (interval.includes('#')) {
                    return this.data.enharmonicNames[canonicalTarget].sharp;
                } else {
                    if (this.state.isFlatMode) {
                        return this.data.enharmonicNames[canonicalTarget].flat;
                    } else {
                        return this.data.enharmonicNames[canonicalTarget].sharp;
                    }
                }
            },
            
            // Genera la secuencia de notas aleatorias
            generateSequence: function() {
                this.stopPlayback();
                this.initTone();
                const scaleType = this.elements.scaleSelect.value;
                const availableIntervals = [];

                if (scaleType === 'Major' || scaleType === 'Minor') {
                    availableIntervals.push(...this.data.scalesData[scaleType]);
                } else { // Personalizada
                    const selectedButtons = Array.from(document.querySelectorAll('#intervalGrid .bg-blue-600, #chromaticNotesGrid .bg-blue-600'));
                    if (this.state.customScaleMode === 'formula') {
                        availableIntervals.push(...selectedButtons.map(btn => btn.getAttribute('data-interval')));
                    } else { // modo notas
                        const rootNoteCanonical = this.elements.rootNoteSelector.value;
                        const rootIndex = this.data.chromaticNotesCanonical.indexOf(rootNoteCanonical);
                        const selectedCanonicalNotes = selectedButtons.map(btn => btn.getAttribute('data-note'));
                        
                        selectedCanonicalNotes.forEach(note => {
                            const noteIndex = this.data.chromaticNotesCanonical.indexOf(note);
                            const semitones = (noteIndex - rootIndex + 12) % 12;
                            const interval = Object.keys(this.data.intervalSemitones).find(key => this.data.intervalSemitones[key] === semitones);
                            if (interval) {
                                availableIntervals.push(interval);
                            }
                        });
                    }
                }

                for (let i = availableIntervals.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [availableIntervals[i], availableIntervals[j]] = [availableIntervals[j], availableIntervals[i]];
                }
                
                const numNotes = parseInt(this.elements.numNotesSelect.value, 10);
                this.state.randomSequence = availableIntervals.slice(0, numNotes);
                
                this.updateUI();
            },

            // Actualiza toda la interfaz de usuario
            updateUI: function() {
                this.updateResolutionsUI();
                this.updateFinalCombinationUI();
            },
            
            // Actualiza el panel de resoluciones
            updateResolutionsUI: function() {
                const rootNoteCanonical = this.elements.rootNoteSelector.value;
                this.elements.majorResolutionsPanel.innerHTML = '';
                this.elements.minorResolutionsPanel.innerHTML = '';

                const createButtons = (resolutions, parent) => {
                    resolutions.forEach((resolution) => {
                        const button = document.createElement('button');
                        const isSelected = this.state.selectedResolutions.includes(resolution.id);
                        button.className = `resolution-button ${isSelected ? 'selected' : ''}`;
                        button.setAttribute('data-id', resolution.id);
                        
                        const noteNamesHtml = resolution.formula.map(interval => 
                            `<span class="note-name note-to-highlight">${this.getNoteName(rootNoteCanonical, interval)}</span>`
                        ).join(' → ');
                        
                        const formulaPartsHtml = resolution.formula.map(interval => 
                            `<span class="formula-part">${interval}</span>`
                        ).join(' ');

                        button.innerHTML = `
                            <span>${resolution.name}</span>
                            <span class="resolution-description">(${formulaPartsHtml})<br/>(${noteNamesHtml})</span>
                        `;
                        parent.appendChild(button);
                    });
                };

                createButtons(this.data.resolutionsMajor, this.elements.majorResolutionsPanel);
                createButtons(this.data.resolutionsMinor, this.elements.minorResolutionsPanel);
            },

            // Maneja el clic en un botón de resolución
            handleResolutionClick: async function(event) {
                const button = event.target.closest('.resolution-button');
                if (!button) return;
                const id = button.getAttribute('data-id');
                const index = this.state.selectedResolutions.indexOf(id);
                const resolution = [...this.data.resolutionsMajor, ...this.data.resolutionsMinor].find(res => res.id === id);

                // Detener cualquier reproducción en curso antes de manejar el clic
                this.stopPlayback();

                if (index === -1) {
                    // Si el botón no está seleccionado, lo seleccionamos y reproducimos
                    this.initTone();
                    if (resolution) {
                        const noteElements = Array.from(button.querySelectorAll('.note-to-highlight, .formula-part'));
                        await this.playSequence(resolution.formula, noteElements);
                    }
                    this.state.selectedResolutions.push(id);
                    button.classList.add('selected');
                } else {
                    // Si el botón ya está seleccionado, lo deseleccionamos
                    this.state.selectedResolutions.splice(index, 1);
                    button.classList.remove('selected');
                }
                this.updateFinalCombinationUI();
            },

            // Maneja el clic en una nota de la combinación final
            handleFinalCombinationClick: function(event) {
                const item = event.target.closest('.note-item');
                if (!item) return;

                const indexToRemove = Array.from(item.parentNode.children).indexOf(item);
                const isResolutionNote = indexToRemove >= this.state.randomSequence.length;

                if (isResolutionNote) {
                    const allResolutions = [...this.data.resolutionsMajor, ...this.data.resolutionsMinor];
                    let currentLength = this.state.randomSequence.length;
                    
                    for (const id of this.state.selectedResolutions) {
                        const resolution = allResolutions.find(res => res.id === id);
                        if (resolution) {
                            const resolutionEndIndex = currentLength + resolution.formula.length;
                            if (indexToRemove >= currentLength && indexToRemove < resolutionEndIndex) {
                                this.state.selectedResolutions = this.state.selectedResolutions.filter(resId => resId !== id);
                                break;
                            }
                            currentLength = resolutionEndIndex;
                        }
                    }
                    this.updateUI();
                }
            },

            // Muestra un mensaje temporal en la pantalla
            showMessage: function(message) {
                const messageBox = document.createElement('div');
                messageBox.className = 'fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-red-600 text-white p-4 rounded-lg z-50 text-center shadow-lg';
                messageBox.innerHTML = message;
                document.body.appendChild(messageBox);
                setTimeout(() => messageBox.remove(), 3000);
            },

            // Actualiza el panel de combinación final
            updateFinalCombinationUI: function() {
                this.elements.finalCombinationList.innerHTML = '';
                const allResolutions = [...this.data.resolutionsMajor, ...this.data.resolutionsMinor];
                
                const finalSequenceDisplay = [...this.state.randomSequence.map(interval => ({ interval: interval, type: 'random' }))];
                
                this.state.selectedResolutions.forEach(id => {
                    const resolution = allResolutions.find(res => res.id === id);
                    if (resolution) {
                        finalSequenceDisplay.push(...resolution.formula.map(interval => ({ interval: interval, type: 'resolution' })));
                    }
                });

                if (finalSequenceDisplay.length === 0) {
                    this.elements.finalCombinationList.innerHTML = '<span class="note-item">Vacío</span>';
                } else {
                    finalSequenceDisplay.forEach((seqNote, index) => {
                        const rootNoteCanonical = this.elements.rootNoteSelector.value;
                        const noteName = this.getNoteName(rootNoteCanonical, seqNote.interval);
                        const noteItem = document.createElement('div');
                        noteItem.className = 'note-item';
                        noteItem.textContent = noteName;
                        noteItem.setAttribute('data-index', index);
                        this.elements.finalCombinationList.appendChild(noteItem);
                    });
                }
            },
            
            // Reproduce una secuencia de notas
            playSequence: async function(notes, highlightElements = []) {
                if (this.state.isPlaying) return;
                
                this.elements.playButton.classList.add('hidden');
                this.elements.stopButton.classList.remove('hidden');

                const rootNoteCanonical = this.elements.rootNoteSelector.value;
                const bpm = parseInt(this.elements.bpmInput.value, 10);
                const rhythmFactor = parseFloat(this.elements.rhythmSelector.value);
                const noteDuration = (60000 / bpm) * rhythmFactor;
                const rootMidi = Tone.Frequency(rootNoteCanonical + '4').toMidi();
                
                this.state.isPlaying = true;
                
                try {
                    for (let i = 0; i < notes.length; i++) {
                        if (!this.state.isPlaying) break;
                        const interval = notes[i];
                        const semitones = this.data.intervalSemitones[interval];
                        const noteMidi = rootMidi + semitones;
                        const noteFreq = Tone.Midi(noteMidi).toFrequency();

                        // Resalta el elemento si existe
                        if (highlightElements[i]) {
                            // CORRECCIÓN: Usamos la clase 'playing' o 'playing-note' según el tipo de elemento
                            if (highlightElements[i].classList.contains('note-item')) {
                                highlightElements[i].classList.add('playing');
                            } else {
                                highlightElements[i].classList.add('playing-note');
                            }
                        }
                        
                        if (this.state.synth) {
                            this.state.synth.triggerAttackRelease(noteFreq, noteDuration / 1000);
                        }
                        
                        await new Promise(resolve => setTimeout(resolve, noteDuration));
                        
                        // Remueve el resaltado
                        if (highlightElements[i]) {
                            highlightElements[i].classList.remove('playing', 'playing-note');
                        }
                    }
                } catch (error) {
                    console.error('Error during playback:', error);
                    this.showMessage('Ocurrió un error al reproducir la música.');
                } finally {
                    this.stopPlayback();
                }
            },

            // Detiene la reproducción
            stopPlayback: function() {
                this.state.isPlaying = false;
                if (this.state.synth) {
                    this.state.synth.releaseAll();
                }
                const highlighted = document.querySelectorAll('.playing, .playing-note');
                highlighted.forEach(el => el.classList.remove('playing', 'playing-note'));
                this.elements.playButton.classList.remove('hidden');
                this.elements.stopButton.classList.add('hidden');
            },

            // Reproduce la secuencia combinada
            playCombinedSequence: async function() {
                this.stopPlayback();
                this.initTone();
                const fullSequence = [...this.state.randomSequence];
                const allResolutions = [...this.data.resolutionsMajor, ...this.data.resolutionsMinor];
                
                if (this.state.selectedResolutions.length > 0) {
                    this.state.selectedResolutions.forEach(id => {
                        const resolution = allResolutions.find(res => res.id === id);
                        if (resolution) {
                            fullSequence.push(...resolution.formula);
                        }
                    });
                }

                if (fullSequence.length === 0) {
                    this.showMessage('No hay secuencia para reproducir.');
                    return;
                }
                
                const highlightElements = Array.from(this.elements.finalCombinationList.querySelectorAll('.note-item'));
                await this.playSequence(fullSequence, highlightElements);
            },

            // Limpia toda la aplicación
            clearAll: function() {
                this.stopPlayback();
                this.state.randomSequence = [];
                this.state.selectedResolutions = [];
                const buttons = document.querySelectorAll('.resolution-button.selected');
                buttons.forEach(button => button.classList.remove('selected'));
                const customScaleButtons = document.querySelectorAll('#intervalGrid .bg-blue-600, #chromaticNotesGrid .bg-blue-600');
                customScaleButtons.forEach(button => button.classList.remove('bg-blue-600'));
                this.updateUI();
            }
        };

        // Inicia la aplicación cuando el DOM esté cargado
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>

