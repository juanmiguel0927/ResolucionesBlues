<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Resoluciones Blues</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        
        /* The main body is set to a specific background color and font, with flexbox to center content. */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0C1821;
            color: #E0E0E0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 0.25rem;
            box-sizing: border-box;
            overflow: hidden; /* Prevent ALL scrolling, as per the user's request */
            font-size: 0.9rem; /* Reduced base font size */
        }
        
        /* The container now uses flexbox for vertical stacking and has no overflow */
        .container {
            background-color: #0C1821;
            padding: 0.25rem; /* Reduced padding */
            border-radius: 1rem;
            box-shadow: none; 
            width: 100%;
            max-width: 600px;
            border: none;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            overflow: hidden;
            flex-grow: 1; /* Allow the container to grow and fill available space */
        }
        
        h1 {
            margin-bottom: 0;
            font-size: 1.75rem; /* Reduced font size */
        }

        .subtitle {
            margin-bottom: 0.1rem; 
            font-size: 0.7rem; /* Reduced font size */
        }
        
        .credits {
            margin-top: 0.1rem; 
            font-size: 0.6rem; /* Reduced font size */
            color: #BDBDBD;
        }
        
        .controls-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 300px;
            margin-top: 0.25rem; /* Reduced margin */
            flex-shrink: 0; /* Prevent the controls from shrinking */
        }

        .controls-row {
            display: flex;
            gap: 0.25rem; /* Reduced gap */
            justify-content: center;
            align-items: center;
            margin-bottom: 0.1rem;
            width: 100%;
        }

        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 0.1rem; 
            width: 100%;
        }

        .select-label {
            margin-bottom: 0.05rem;
            font-weight: bold;
            font-size: 0.75rem; /* Reduced font size */
        }

        .select-input {
            width: 100%;
            padding: 0.15rem; /* Reduced padding */
            border-radius: 0.4rem;
            background-color: #333;
            color: #E0E0E0;
            border: 1px solid #444;
            text-align: center;
            font-size: 0.7rem; /* Reduced font size */
        }
        
        .action-button {
            padding: 0.4rem 0.8rem; /* Reduced padding */
            font-size: 0.75rem; /* Reduced font size */
            font-weight: bold;
            border-radius: 0.4rem;
            cursor: pointer;
            transition: transform 0.1s ease-in-out, background-color 0.1s ease-in-out;
            margin-top: 0.25rem; /* Reduced margin */
        }
        
        .generate-button {
            background-color: #F39C12;
            color: white;
            width: 100%;
        }
        .generate-button:hover {
            background-color: #E67E22;
        }
        
        .resolution-button {
            width: 100%;
            padding: 0.4rem; /* Reduced padding */
            font-size: 0.7rem; /* Reduced font size */
            font-weight: bold;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            border-radius: 0.4rem;
            cursor: pointer;
            transition: transform 0.1s ease-in-out, background-color 0.1s ease-in-out;
            user-select: none;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2);
            background-color: #1E8449;
            color: white;
            border: none;
            text-align: center;
        }
        .resolution-button:hover {
            background-color: #27AE60;
        }
        .resolution-button:active {
            transform: scale(0.95);
        }
        
        .resolution-button.selected {
            background-color: #F1C40F;
            color: #0C1821;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.4);
        }

        .resolution-description {
            font-size: 0.6rem; /* Reduced font size */
            color: #BDBDBD;
            margin-top: 0.1rem;
            font-weight: normal;
        }
        
        .highlighted-note {
            color: #F1C40F;
            font-weight: bold;
            transition: color 0.1s ease-in-out;
        }

        .highlighted-item {
            background-color: #3498DB !important;
            transition: background-color 0.1s ease-in-out;
        }

        .resolution-button.selected .resolution-description {
            color: #333;
        }
        
        /* New grid for resolutions to save space */
        .resolutions-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.2rem; /* Reduced gap */
        }
        
        .selection-panel {
            background-color: #2C3E50;
            border-radius: 0.4rem;
            padding: 0.4rem; /* Reduced padding */
            margin-top: 0.25rem; /* Reduced margin */
            width: 100%;
            flex-shrink: 1; /* Allow this panel to shrink */
            overflow-y: auto; /* Allow scrolling within the resolutions panel if needed */
        }

        .resolutions-section {
            margin-top: 0.15rem; /* Reduced margin */
        }

        .section-title {
            font-size: 0.8rem; /* Reduced font size */
            font-weight: bold;
            margin-bottom: 0.15rem; 
            padding-left: 0.15rem;
        }

        .selection-panel-title {
            font-size: 0.85rem; /* Reduced font size */
            font-weight: bold;
            margin-bottom: 0.15rem; 
        }

        .selection-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.15rem; /* Reduced gap */
            min-height: 0.8rem; /* Reduced height */
            font-size: 0.7rem; /* Reduced font size */
        }

        .selected-item {
            background-color: #5D5D5D;
            color: #E0E0E0;
            padding: 0.1rem 0.3rem; /* Reduced padding */
            border-radius: 0.2rem;
            font-size: 0.65rem; /* Reduced font size */
            transition: background-color 0.1s ease-in-out;
        }

        .action-buttons {
            display: flex;
            gap: 0.25rem; /* Reduced gap */
            margin-top: 0.25rem; /* Reduced margin */
            justify-content: center;
            width: 100%;
            flex-shrink: 0; /* Prevent the action buttons from shrinking */
        }
        
        .play-button {
            background-color: #3498DB;
            color: white;
        }
        .play-button:hover {
            background-color: #2980B9;
        }

        .clear-button {
            background-color: #E74C3C;
            color: white;
        }
        .clear-button:hover {
            background-color: #C0392B;
        }

        .random-sequence-panel {
            background-color: #1A2430;
            border-radius: 0.4rem;
            padding: 0.4rem; /* Reduced padding */
            margin-top: 0.25rem;
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-shrink: 0; /* Prevent the random sequence panel from shrinking */
        }

        .random-sequence-notes {
            font-size: 0.7rem; /* Reduced font size */
            font-weight: bold;
            text-align: center;
            min-height: 0.8rem;
            margin-bottom: 0.15rem;
            width: 100%;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.15rem;
        }

        .hidden {
            display: none;
        }

        .custom-scale-mode-selector {
            display: flex;
            justify-content: center;
            gap: 0.25rem; /* Reduced gap */
            margin-bottom: 0.25rem;
        }
        
        .custom-mode-button {
            padding: 0.1rem 0.4rem; /* Reduced padding */
            font-size: 0.65rem; /* Reduced font size */
            background-color: #5D5D5D;
            color: white;
            border-radius: 0.2rem;
            cursor: pointer;
            border: 1px solid #444;
        }

        .custom-mode-button.active {
            background-color: #F39C12;
            color: #0C1821;
        }
        
        .custom-intervals-grid, .chromatic-notes-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.15rem; /* Reduced gap */
            margin-top: 0.15rem;
        }

        .custom-interval-button, .chromatic-note-button {
            background-color: #5D5D5D;
            color: #E0E0E0;
            padding: 0.3rem; /* Reduced padding */
            border-radius: 0.2rem;
            font-size: 0.65rem; /* Reduced font size */
            text-align: center;
            cursor: pointer;
            transition: background-color 0.1s ease-in-out;
        }

        .custom-interval-button.selected-interval, .chromatic-note-button.selected-note {
            background-color: #27AE60;
        }

        .toggle-random-button {
            background-color: #3498DB;
            color: white;
            width: 100%;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>

    <div class="container mx-auto rounded-xl">
        <h1 class="text-3xl font-bold text-center">Resoluciones Blues</h1>
        <p class="text-center text-gray-400 subtitle">
            Selecciona una escala, genera una melodía aleatoria y añade resoluciones.
        </p>
        <p class="text-center credits">Diseñado por Juan Miguel Ríos Redondo</p>
        
        <div class="controls-container">
            <div class="controls-row">
                <div class="controls">
                    <label for="scaleSelect" class="select-label">Escala:</label>
                    <select id="scaleSelect" class="select-input">
                        <option value="Mayor">Mayor</option>
                        <option value="Menor">Menor</option>
                        <option value="Personalizada">Personalizada</option>
                    </select>
                </div>
                <div class="controls">
                    <label for="rootNote" class="select-label">Fundamental:</label>
                    <select id="rootNote" class="select-input">
                        <!-- Options are now dynamically generated by JS -->
                    </select>
                </div>
            </div>
            
            <div id="customScaleInputContainer" class="controls hidden">
                <div class="custom-scale-mode-selector">
                    <button id="formulaModeButton" class="custom-mode-button active">Fórmula</button>
                    <button id="notesModeButton" class="custom-mode-button">Notas</button>
                </div>
                <div id="intervalGrid" class="custom-intervals-grid">
                    <!-- Interval buttons will be generated by JavaScript -->
                </div>
                <div id="chromaticNotesGrid" class="chromatic-notes-grid hidden">
                    <!-- Chromatic note buttons will be generated by JavaScript -->
                </div>
            </div>
            
            <div class="controls-row">
                <div class="controls">
                    <label for="bpm" class="select-label">BPM:</label>
                    <input type="number" id="bpm" class="select-input" value="160" min="40" max="240">
                </div>
                <div class="controls">
                    <label for="rhythm" class="select-label">Ritmo:</label>
                    <select id="rhythm" class="select-input">
                        <option value="1">Negra</option>
                        <option value="0.5" selected>Corchea</option>
                        <option value="0.25">Semicorchea</option>
                    </select>
                </div>
            </div>
            <div class="controls-row">
                 <div class="controls">
                    <label for="numNotesSelect" class="select-label">Notas Aleatorias (1-7):</label>
                    <select id="numNotesSelect" class="select-input">
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5" selected>5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                    </select>
                </div>
                <div class="controls">
                    <button id="enharmonicToggleButton" class="action-button play-button">Mostrar Bemoles (b)</button>
                </div>
            </div>
        </div>

        <div class="action-buttons">
            <button id="generate-sequence-button" class="action-button generate-button">Generar Secuencia Aleatoria</button>
        </div>
        
        <div class="random-sequence-panel">
            <div id="random-sequence-display" class="random-sequence-notes"></div>
        </div>

        <div class="selection-panel">
            <div class="selection-panel-title">Resoluciones Blues:</div>
            <div class="resolutions-section">
                <p class="section-title">Mayores y Dominantes</p>
                <div id="major-resolutions-panel" class="resolutions-grid">
                    <!-- Buttons will be generated by JavaScript -->
                </div>
            </div>
            <div class="resolutions-section">
                <p class="section-title">Menores</p>
                <div id="minor-resolutions-panel" class="resolutions-grid">
                    <!-- Buttons will be generated by JavaScript -->
                </div>
            </div>
        </div>

        <div class="selection-panel">
            <div class="selection-panel-title">Combinación Final:</div>
            <div id="final-combination-list" class="selection-list">
                <!-- Notes of the final combination will be displayed here -->
            </div>
        </div>
        
        <div class="action-buttons">
            <button id="play-combination-button" class="action-button play-button">Reproducir</button>
            <button id="clear-selection-button" class="action-button clear-button">Limpiar Todo</button>
        </div>

    </div>

    <script>
        // Global variables for Tone.js synth and effects
        let synth;
        let reverb;
        let isPlaying = false;
        
        // Arrays to store the note sequences
        let randomSequence = [];
        let selectedResolutions = [];
        
        // State for the custom scale input mode and enharmonic display
        let customScaleMode = 'formula'; // 'formula' or 'notes'
        let isFlatMode = false;
        
        // Mapping intervals to semitones from the root note
        const intervalSemitones = {
            '1': 0, '2': 2, 'b2': 1, '#2': 3, 'bb3': 2, 'b3': 3, '3': 4, '4': 5, '#4': 6, 'b5': 6, '5': 7, '#5': 8, 'b6': 8, '6': 9, 'b7': 10, '7': 11, 'bb7': 9, '#9': 4, '#13': 9
        };

        // Mapping semitones to standard interval names (now more flexible)
        const semitoneToInterval = {
            0: '1', 1: 'b2', 2: '2', 3: 'b3', 4: '3', 5: '4', 6: 'b5', 7: '5', 8: 'b6', 9: '6', 10: 'b7', 11: '7'
        };
        
        // Internal canonical chromatic notes for calculations
        const chromaticNotesCanonical = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

        // Note names for sharps and flats, used for display. We need to define these for our corrected logic.
        const noteNames = {
            'C': { flat: 'C', sharp: 'C' },
            'C#': { flat: 'Db', sharp: 'C#' },
            'D': { flat: 'D', sharp: 'D' },
            'D#': { flat: 'Eb', sharp: 'D#' },
            'E': { flat: 'E', sharp: 'E' },
            'F': { flat: 'F', sharp: 'F' },
            'F#': { flat: 'Gb', sharp: 'F#' },
            'G': { flat: 'G', sharp: 'G' },
            'G#': { flat: 'Ab', sharp: 'G#' },
            'A': { flat: 'A', sharp: 'A' },
            'A#': { flat: 'Bb', sharp: 'A#' },
            'B': { flat: 'B', sharp: 'B' }
        };

        // All intervals for the custom scale selector
        const allIntervals = ['1', 'b2', '2', '#2', 'b3', '3', '4', '#4', 'b5', '5', '#5', 'b6', '6', 'b7', '7'];

        // Scale data with simple names
        const scalesData = {
            'Mayor': ['1', '2', '3', '4', '5', '6', '7'],
            'Menor': ['1', '2', 'b3', '4', '5', 'b6', 'b7'] // Eólico
        };

        // Resolutions for major and dominant chords
        const resolutionsMajor = [
            { id: 'major-0', name: 'Resolución de #2', formula: ['#2', '3', '1'] },
            { id: 'major-1', name: 'Resolución de b3', formula: ['b3', '2', '1'] },
            { id: 'major-2', name: 'Resolución de 4', formula: ['4', '#2', '3', '1'] },
            { id: 'major-3', name: 'Resolución de #4', formula: ['3', '4', '#4', '5', '#2', '3', '1'] },
            { id: 'major-4', name: 'Resolución de b5', formula: ['b5', '4', '#2', '3', '1'] },
            { id: 'major-5', name: 'Resolución de b7 versión 1', formula: ['b7', '5'] },
            { id: 'major-6', name: 'Resolución de b7 versión 2', formula: ['b7', '6', '5'] },
        ];
        
        // Resolutions for minor chords
        const resolutionsMinor = [
            { id: 'minor-0', name: 'Resolución de 2', formula: ['2', 'b3', '1'] },
            { id: 'minor-1', name: 'Resolución de b5', formula: ['b5', '5', 'b3'] },
            { id: 'minor-2', name: 'Resolución de b7', formula: ['b7', '6', '5', 'b3'] },
            { id: 'minor-3', name: 'Resolución de 6', formula: ['6', 'b7', 'b3'] },
        ];

        document.addEventListener('DOMContentLoaded', () => {
            // Get references to all UI elements
            const scaleSelect = document.getElementById('scaleSelect');
            const customScaleInputContainer = document.getElementById('customScaleInputContainer');
            const rootNoteSelector = document.getElementById('rootNote');
            const enharmonicToggleButton = document.getElementById('enharmonicToggleButton');
            const numNotesSelect = document.getElementById('numNotesSelect');
            const bpmInput = document.getElementById('bpm');
            const rhythmSelector = document.getElementById('rhythm');
            const generateButton = document.getElementById('generate-sequence-button');
            const majorResolutionsPanel = document.getElementById('major-resolutions-panel');
            const minorResolutionsPanel = document.getElementById('minor-resolutions-panel');
            const playButton = document.getElementById('play-combination-button');
            const clearButton = document.getElementById('clear-selection-button');
            const randomSequenceDisplay = document.getElementById('random-sequence-display');
            const finalCombinationList = document.getElementById('final-combination-list');
            const formulaModeButton = document.getElementById('formulaModeButton');
            const notesModeButton = document.getElementById('notesModeButton');
            const intervalGrid = document.getElementById('intervalGrid');
            const chromaticNotesGrid = document.getElementById('chromaticNotesGrid');

            // Event listeners
            scaleSelect.addEventListener('change', () => {
                handleScaleSelectChange();
                updateUI();
            });

            rootNoteSelector.addEventListener('change', () => {
                updateUI();
                // If a random sequence exists, regenerate it with the new root note
                if (randomSequence.length > 0) {
                    generateRandomSequence();
                }
            });
            
            // New event listener for the number of random notes selector
            numNotesSelect.addEventListener('change', () => {
                // Only generate a new sequence if one already exists
                if (randomSequence.length > 0) {
                    generateRandomSequence();
                }
            });

            enharmonicToggleButton.addEventListener('click', () => {
                toggleEnharmonicMode();
                updateUI(); // Calls updateUI to refresh all notes
                // If a random sequence exists, regenerate its display with the new enharmonic mode
                if (randomSequence.length > 0) {
                    updateRandomSequenceDisplay();
                    updateFinalCombinationUI();
                }
            });
            generateButton.addEventListener('click', generateRandomSequence);

            majorResolutionsPanel.addEventListener('click', handleResolutionClick);
            minorResolutionsPanel.addEventListener('click', handleResolutionClick);
            playButton.addEventListener('click', playCombinedSequence);
            clearButton.addEventListener('click', clearAll);
            formulaModeButton.addEventListener('click', () => setCustomScaleMode('formula'));
            notesModeButton.addEventListener('click', () => setCustomScaleMode('notes'));
            
            // Initial UI generation and setup
            updateUI();
            generateIntervalsUI();
            generateChromaticNotesUI();
            
            // Function to initialize Tone.js (now more robust)
            async function initTone() {
                if (Tone.context.state !== 'running') {
                    await Tone.start();
                }
                
                if (!synth) {
                    // Set up the synthesizer and effects
                    synth = new Tone.PolySynth(Tone.FMSynth, {
                        oscillator: { type: "triangle" },
                        envelope: {
                            attack: 0.05,
                            decay: 0.1,
                            sustain: 0.3,
                            release: 0.8
                        }
                    }).toDestination();
                    
                    reverb = new Tone.Reverb({
                        decay: 4,
                        preDelay: 0.01,
                        wet: 0.3
                    }).toDestination();

                    synth.connect(reverb);
                    reverb.toDestination();
                }
            }

            // Function to switch between 'formula' and 'notes' mode
            function setCustomScaleMode(mode) {
                customScaleMode = mode;
                formulaModeButton.classList.toggle('active', mode === 'formula');
                notesModeButton.classList.toggle('active', mode === 'notes');
                intervalGrid.classList.toggle('hidden', mode === 'notes');
                chromaticNotesGrid.classList.toggle('hidden', mode === 'formula');
            }

            // Generate the buttons for the custom intervals
            function generateIntervalsUI() {
                allIntervals.forEach(interval => {
                    const button = document.createElement('button');
                    button.className = 'custom-interval-button';
                    button.textContent = interval;
                    button.setAttribute('data-interval', interval);
                    button.addEventListener('click', () => {
                        button.classList.toggle('selected-interval');
                    });
                    intervalGrid.appendChild(button);
                });
            }

            // Generate the buttons for the chromatic scale
            function generateChromaticNotesUI() {
                chromaticNotesGrid.innerHTML = ''; // Clear existing buttons
                chromaticNotesCanonical.forEach(canonicalNote => {
                    const noteToDisplay = isFlatMode ? noteNames[canonicalNote].flat : noteNames[canonicalNote].sharp;
                    const button = document.createElement('button');
                    button.className = 'chromatic-note-button';
                    button.textContent = noteToDisplay;
                    button.setAttribute('data-note', canonicalNote);
                    button.addEventListener('click', () => {
                        button.classList.toggle('selected-note');
                    });
                    chromaticNotesGrid.appendChild(button);
                });
            }

            // Handles changes in the scale dropdown, showing/hiding the custom scale input
            function handleScaleSelectChange() {
                if (scaleSelect.value === 'Personalizada') {
                    customScaleInputContainer.classList.remove('hidden');
                    setCustomScaleMode(customScaleMode); // Restore the last selected mode
                } else {
                    customScaleInputContainer.classList.add('hidden');
                }
            }

            // Toggles between sharp and flat enharmonic display for scales and root note
            function toggleEnharmonicMode() {
                isFlatMode = !isFlatMode;
                enharmonicToggleButton.textContent = isFlatMode ? 'Mostrar Sostenidos (#)' : 'Mostrar Bemoles (b)';
                updateRootNoteSelector();
                generateChromaticNotesUI(); // Re-render chromatic notes with new enharmonic spelling
            }

            // Updates the root note selector options with the correct enharmonic spelling
            function updateRootNoteSelector() {
                const currentCanonicalRoot = rootNoteSelector.value || 'C'; // Get current value or default to 'C'
                rootNoteSelector.innerHTML = '';
                
                const notesToDisplay = isFlatMode ? ['C', 'Db', 'D', 'Eb', 'E', 'F', 'Gb', 'G', 'Ab', 'A', 'Bb', 'B'] : ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
                
                notesToDisplay.forEach(noteToDisplay => {
                    // Find the canonical note for the displayed name.
                    const canonicalNote = Object.keys(noteNames).find(key => noteNames[key].flat === noteToDisplay || noteNames[key].sharp === noteToDisplay);
                    const option = document.createElement('option');
                    option.value = canonicalNote;
                    option.textContent = noteToDisplay; 
                    rootNoteSelector.appendChild(option);
                });

                // Restore the selected value using its canonical name
                rootNoteSelector.value = currentCanonicalRoot;
                if (!rootNoteSelector.value) {
                    rootNoteSelector.value = 'C';
                }
            }

            // Main function to update all UI elements that display notes
            function updateUI() {
                updateResolutionsUI();
                updateRandomSequenceDisplay();
                updateFinalCombinationUI();
            }
            
            /**
             * Determines the correct enharmonic note name based on the root note and the current enharmonic mode.
             * This function has been corrected to simplify the logic and ensure it works reliably.
             * @param {string} rootCanonical - The canonical root note (e.g., 'C', 'A#').
             * @param {string} interval - The interval formula (e.g., 'b3', '5').
             * @returns {string} The correctly spelled note name (e.g., 'Db' for a b3 in a Bb scale).
             */
            function getNoteName(rootCanonical, interval) {
                // Get the index of the root note in the chromatic scale
                const rootIndex = chromaticNotesCanonical.indexOf(rootCanonical);
                // Get the semitones for the given interval
                const semitones = intervalSemitones[interval];
                
                if (semitones === undefined) {
                    return 'N/A';
                }
                
                // Calculate the index of the target note in the chromatic scale
                const targetChromaticIndex = (rootIndex + semitones + 12) % 12;
                const canonicalNoteAtTarget = chromaticNotesCanonical[targetChromaticIndex];
                
                // Use the enharmonic mode to select the correct spelling
                return isFlatMode ? noteNames[canonicalNoteAtTarget].flat : noteNames[canonicalNoteAtTarget].sharp;
            }
            
            // Function to update the resolution buttons' UI based on the selected root note
            function updateResolutionsUI() {
                const rootNoteCanonical = rootNoteSelector.value;
                majorResolutionsPanel.innerHTML = '';
                minorResolutionsPanel.innerHTML = '';

                // Create major resolution buttons
                resolutionsMajor.forEach((resolution) => {
                    const button = document.createElement('button');
                    button.className = 'resolution-button';
                    button.setAttribute('data-id', resolution.id);
                    
                    // Generate the HTML for the note names and formula parts with unique IDs
                    const noteNamesHtml = resolution.formula.map((interval, idx) => 
                        `<span class="note-name note-name-${resolution.id}-${idx}">${getNoteName(rootNoteCanonical, interval)}</span>`
                    ).join(' → ');
                    
                    const formulaPartsHtml = resolution.formula.map((interval, idx) => 
                        `<span class="formula-part formula-part-${resolution.id}-${idx}">${interval}</span>`
                    ).join(' ');

                    button.innerHTML = `
                        <span>${resolution.name}</span>
                        <span class="resolution-description">(${formulaPartsHtml})<br/>(${noteNamesHtml})</span>
                    `;
                    
                    if (selectedResolutions.includes(resolution.id)) {
                        button.classList.add('selected');
                    }
                    
                    majorResolutionsPanel.appendChild(button);
                });

                // Create minor resolution buttons
                resolutionsMinor.forEach((resolution) => {
                    const button = document.createElement('button');
                    button.className = 'resolution-button';
                    button.setAttribute('data-id', resolution.id);
                    
                    // Generate the HTML for the note names and formula parts with unique IDs
                    const noteNamesHtml = resolution.formula.map((interval, idx) => 
                        `<span class="note-name note-name-${resolution.id}-${idx}">${getNoteName(rootNoteCanonical, interval)}</span>`
                    ).join(' → ');
                    
                    const formulaPartsHtml = resolution.formula.map((interval, idx) => 
                        `<span class="formula-part formula-part-${resolution.id}-${idx}">${interval}</span>`
                    ).join(' ');

                    button.innerHTML = `
                        <span>${resolution.name}</span>
                        <span class="resolution-description">(${formulaPartsHtml})<br/>(${noteNamesHtml})</span>
                    `;
                    
                    if (selectedResolutions.includes(resolution.id)) {
                        button.classList.add('selected');
                    }
                    
                    minorResolutionsPanel.appendChild(button);
                });
            }

            // Handles resolution button clicks
            async function handleResolutionClick(event) {
                const button = event.target.closest('.resolution-button');
                if (!button) return;
                
                const id = button.getAttribute('data-id');
                const resolution = [...resolutionsMajor, ...resolutionsMinor].find(res => res.id === id);
                if (!resolution) return;
                
                const index = selectedResolutions.indexOf(id);

                if (index === -1) {
                    // Play the resolution only when selecting it
                    await playResolution(resolution.formula, resolution.id);
                    selectedResolutions.push(id);
                    button.classList.add('selected');
                } else {
                    // Do not play sound when deselecting
                    selectedResolutions.splice(index, 1);
                    button.classList.remove('selected');
                }
                
                updateFinalCombinationUI();
            }

            // Plays a single resolution from its formula
            async function playResolution(formula, resId) {
                await initTone();
                if (isPlaying) return;

                const rootNoteCanonical = rootNoteSelector.value;
                const bpm = parseInt(bpmInput.value, 10);
                const rhythmFactor = parseFloat(rhythmSelector.value);
                const noteDuration = (60000 / bpm) * rhythmFactor;
                
                const rootMidi = Tone.Frequency(rootNoteCanonical + '4').toMidi();
                
                isPlaying = true;
                for (let i = 0; i < formula.length; i++) {
                    const interval = formula[i];
                    
                    const semitones = intervalSemitones[interval];
                    const noteMidi = rootMidi + semitones;
                    const noteFreq = Tone.Midi(noteMidi).toFrequency();

                    // Highlight the note in the resolution button while it plays
                    const noteElement = document.querySelector(`.note-name-${resId}-${i}`);
                    const formulaElement = document.querySelector(`.formula-part-${resId}-${i}`);
                    if (noteElement) noteElement.classList.add('highlighted-note');
                    if (formulaElement) formulaElement.classList.add('highlighted-note');
                    
                    synth.triggerAttackRelease(noteFreq, noteDuration / 1000);
                    
                    await new Promise(resolve => setTimeout(resolve, noteDuration));
                    
                    // Remove highlight after note plays
                    if (noteElement) noteElement.classList.remove('highlighted-note');
                    if (formulaElement) formulaElement.classList.remove('highlighted-note');
                }
                isPlaying = false;
            }

            // Generate a random, non-repeating sequence of notes from the selected scale
            function generateRandomSequence() {
                const selectedScaleName = scaleSelect.value;
                let scaleIntervals;
                const rootNoteCanonical = rootNoteSelector.value;

                if (selectedScaleName === 'Personalizada') {
                    if (customScaleMode === 'formula') {
                        // Get intervals from the selected interval buttons
                        const selectedButtons = document.querySelectorAll('#intervalGrid .selected-interval');
                        if (selectedButtons.length === 0) {
                            showMessage("Por favor, selecciona al menos un intervalo para tu escala personalizada.");
                            return;
                        }
                        scaleIntervals = Array.from(selectedButtons).map(btn => btn.getAttribute('data-interval'));
                    } else if (customScaleMode === 'notes') {
                        // Get notes from the selected chromatic buttons and convert to intervals
                        const selectedNotes = Array.from(document.querySelectorAll('.chromatic-note-button.selected-note')).map(btn => btn.getAttribute('data-note'));
                        if (selectedNotes.length === 0) {
                            showMessage("Por favor, selecciona al menos una nota para tu escala personalizada.");
                            return;
                        }
                        scaleIntervals = selectedNotes.map(noteCanonical => {
                            const rootIndex = chromaticNotesCanonical.indexOf(rootNoteCanonical);
                            const noteIndex = chromaticNotesCanonical.indexOf(noteCanonical);
                            const semitoneDifference = (noteIndex - rootIndex + 12) % 12;
                            return semitoneToInterval[semitoneDifference];
                        });
                    }
                } else {
                    scaleIntervals = scalesData[selectedScaleName];
                }

                const numNotes = parseInt(numNotesSelect.value, 10);
                
                // Ensure the number of notes doesn't exceed the scale's length
                if (numNotes > scaleIntervals.length) {
                    showMessage(`La escala seleccionada solo tiene ${scaleIntervals.length} notas. Por favor, elige un número menor.`);
                    return;
                }

                // Create a mutable copy of the intervals to prevent repetitions
                let availableIntervals = [...scaleIntervals];
                randomSequence = [];

                for (let i = 0; i < numNotes; i++) {
                    const randomIndex = Math.floor(Math.random() * availableIntervals.length);
                    const randomInterval = availableIntervals.splice(randomIndex, 1)[0];
                    
                    // The note name will be determined on the fly during display for correct enharmonic spelling
                    randomSequence.push({
                        interval: randomInterval,
                        id: `random-${i}`
                    });
                }
                
                updateRandomSequenceDisplay();
                updateFinalCombinationUI();
            }
            
            // Displays a message to the user
            function showMessage(message) {
                const messageBox = document.createElement('div');
                messageBox.style.cssText = `
                    position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                    background-color: #E74C3C; color: white; padding: 1rem; border-radius: 0.5rem;
                    z-index: 1000; text-align: center;
                `;
                messageBox.innerHTML = message;
                document.body.appendChild(messageBox);
                setTimeout(() => messageBox.remove(), 3000);
            }

            // Update the display of the random sequence notes
            function updateRandomSequenceDisplay() {
                if (randomSequence.length === 0) {
                    randomSequenceDisplay.textContent = 'Genera una secuencia...'; // Clear text
                    return;
                }
                const rootNoteCanonical = rootNoteSelector.value;

                const notesHtml = randomSequence.map(note => {
                    const noteName = getNoteName(rootNoteCanonical, note.interval);
                    return `<span class="selected-item" id="note-name-${note.id}">${noteName} (${note.interval})</span>`;
                }).join(' ');
                randomSequenceDisplay.innerHTML = notesHtml;
            }

            // Update the display of the final combined sequence
            function updateFinalCombinationUI() {
                finalCombinationList.innerHTML = '';
                const allResolutions = [...resolutionsMajor, ...resolutionsMinor];
                const finalSequenceDisplay = [];
                const rootNoteCanonical = rootNoteSelector.value;
                
                // Add random sequence notes to the final display
                if (randomSequence.length > 0) {
                     finalSequenceDisplay.push(...randomSequence.map(note => ({
                        note: getNoteName(rootNoteCanonical, note.interval),
                        isRandom: true,
                        id: note.id,
                        interval: note.interval
                     })));
                }

                // Add selected resolution notes to the final display
                if (selectedResolutions.length > 0) {
                    selectedResolutions.forEach(id => {
                        const resolution = allResolutions.find(res => res.id === id);
                        if (resolution) {
                            resolution.formula.forEach((interval, idx) => {
                                finalSequenceDisplay.push({
                                    note: getNoteName(rootNoteCanonical, interval),
                                    isRandom: false,
                                    id: `res-${id}-${idx}`,
                                    interval: interval
                                });
                            });
                        }
                    });
                }
                
                // Render the final list of notes with unique IDs for highlighting
                if (finalSequenceDisplay.length > 0) {
                    finalCombinationList.innerHTML = finalSequenceDisplay.map((seqNote, index) => 
                        `<span class="selected-item final-note-${index}">${seqNote.note}</span>`
                    ).join(' ');
                } else {
                    finalCombinationList.innerHTML = '<span class="selected-item">Vacío</span>';
                }
            }

            // Play the full sequence with a frequency-based approach to control octaves
            async function playCombinedSequence() {
                // Ensure Tone.js is initialized and the audio context is running
                await initTone();
                
                if (isPlaying) {
                    return;
                }
                
                const rootNoteCanonical = rootNoteSelector.value;
                const bpm = parseInt(bpmInput.value, 10);
                const rhythmFactor = parseFloat(rhythmSelector.value);
                const noteDuration = (60000 / bpm) * rhythmFactor;
                const allResolutions = [...resolutionsMajor, ...resolutionsMinor];
                const fullSequence = [];
                
                // Build the complete sequence from random notes and resolutions
                if (randomSequence.length > 0) {
                    fullSequence.push(...randomSequence);
                }

                if (selectedResolutions.length > 0) {
                    selectedResolutions.forEach(id => {
                        const resolution = allResolutions.find(res => res.id === id);
                        if (resolution) {
                            resolution.formula.forEach((interval, idx) => {
                                fullSequence.push({
                                    interval: interval,
                                    isRandom: false,
                                    id: `res-${id}-${idx}`
                                });
                            });
                        }
                    });
                }
                
                if (fullSequence.length === 0) {
                    showMessage('No hay secuencia para reproducir.');
                    return;
                }

                const rootMidi = Tone.Frequency(rootNoteCanonical + '4').toMidi();
                
                isPlaying = true;
                for (let i = 0; i < fullSequence.length; i++) {
                    const seqNote = fullSequence[i];
                    
                    // Highlight the note in the final combination display
                    const finalNoteElement = document.querySelector(`.final-note-${i}`);
                    if (finalNoteElement) finalNoteElement.classList.add('highlighted-item');

                    // If the note belongs to a resolution, highlight it in the original button as well
                    if (!seqNote.isRandom) {
                        const [type, resIndex, noteIndex] = seqNote.id.split('-');
                        const noteElement = document.querySelector(`.note-name-${resIndex}-${noteIndex}`);
                        const formulaElement = document.querySelector(`.formula-part-${resIndex}-${noteIndex}`);
                        if (noteElement) {
                            noteElement.classList.add('highlighted-note');
                        }
                        if (formulaElement) {
                            formulaElement.classList.add('highlighted-note');
                        }
                    }
                    
                    // If it's a random note, also highlight it in the random sequence display
                    if (seqNote.isRandom) {
                       const randomNoteElement = document.getElementById(`note-name-${seqNote.id}`);
                       if (randomNoteElement) {
                           randomNoteElement.classList.add('highlighted-item');
                       }
                    }
                    
                    // Get the semitone offset from the interval
                    const semitones = intervalSemitones[seqNote.interval];
                    // Calculate the new note's MIDI value and convert to frequency
                    const noteMidi = rootMidi + semitones;
                    const noteFreq = Tone.Midi(noteMidi).toFrequency();

                    // Play the note using the calculated frequency
                    synth.triggerAttackRelease(noteFreq, noteDuration / 1000);
                    
                    await new Promise(resolve => setTimeout(resolve, noteDuration));
                    
                    // Remove highlight after note plays
                    if (finalNoteElement) finalNoteElement.classList.remove('highlighted-item');
                    
                    if (!seqNote.isRandom) {
                        const [type, resIndex, noteIndex] = seqNote.id.split('-');
                        const noteElement = document.querySelector(`.note-name-${resIndex}-${noteIndex}`);
                        const formulaElement = document.querySelector(`.formula-part-${resIndex}-${noteIndex}`);
                        if (noteElement) {
                            noteElement.classList.remove('highlighted-note');
                        }
                        if (formulaElement) {
                            formulaElement.classList.remove('highlighted-note');
                        }
                    }

                    if (seqNote.isRandom) {
                        const randomNoteElement = document.getElementById(`note-name-${seqNote.id}`);
                        if (randomNoteElement) {
                            randomNoteElement.classList.remove('highlighted-item');
                        }
                    }
                }
                
                isPlaying = false;
            }

            // Clear all selections and displays
            function clearAll() {
                randomSequence = [];
                selectedResolutions = [];
                const buttons = document.querySelectorAll('.resolution-button.selected');
                buttons.forEach(button => button.classList.remove('selected'));
                const intervalButtons = document.querySelectorAll('.custom-interval-button.selected-interval');
                intervalButtons.forEach(button => button.classList.remove('selected-interval'));
                const chromaticButtons = document.querySelectorAll('.chromatic-note-button.selected-note');
                chromaticButtons.forEach(button => button.classList.remove('selected-note'));
                
                // Clear all highlights
                const allHighlightedNotes = document.querySelectorAll('.highlighted-note');
                allHighlightedNotes.forEach(el => el.classList.remove('highlighted-note'));
                const allHighlightedItems = document.querySelectorAll('.highlighted-item');
                allHighlightedItems.forEach(el => el.classList.remove('highlighted-item'));

                updateRandomSequenceDisplay();
                updateFinalCombinationUI();
            }

            // Initial setup
            updateRootNoteSelector();
            updateRandomSequenceDisplay(); // This now shows the "Generar..." message initially
        });
    </script>
</body>
</html>

